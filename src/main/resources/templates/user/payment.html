<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Thanh toán vé tàu</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link th:href="@{/img/favicon.ico}" rel="shortcut icon" type="image/x-icon">
    <!-- Bootstrap v5.0.1 -->
    <link th:href="@{/css/bootstrap.css}" type="text/css" rel="stylesheet">
    <script th:src="@{/js/bootstrap.bundle.js}" type="text/javascript"></script>
    <!-- Bootstrap Icons v1.5.0 -->
    <link th:href="@{/static/css/bootstrap-icons.css}" type="text/css" rel="stylesheet">
    <!-- Custom Styles -->
    <link th:href="@{/css/styles.css}" type="text/css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/layout.css}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KyZXEJ10x8bH8tQy4bm8a7Unw7CkCz7Y2pA8a6vFtvbA0hZTkNffpV8V4jeIm9xr" crossorigin="anonymous">
    <!-- Bootstrap Icons (optional, for the account icon) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f8f8;
            padding: 40px;
        }

        .ticket-summary {
            margin-top: 1cm;
            margin-left: auto;
            margin-right: auto;
            max-width: 800px;
            /*margin: auto;*/
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .ticket-summary h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .ticket-summary h4 {
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .ticket-summary .form-group {
            margin-bottom: 15px;
        }

        .ticket-summary .form-group label {
            font-weight: 600;
        }

        .ticket-summary .price-detail {
            font-size: 18px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid #ddd;
            padding-top: 15px;
            margin-bottom: 20px;
        }

        .ticket-summary .payment-methods {
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .ticket-summary .btn-pay {
            display: block;
            width: 100%;
            background-color: #4CAF50;
            color: #fff;
            font-weight: bold;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-bottom:20px;
        }

        .ticket-summary .btn-pay:hover {
            background-color: #45a049;
        }
    </style>

    <!--narbar-->
    <style>
        body {
            /*background: url('/img/backG.png') no-repeat center center/cover;*/
            background: url('/img/backG.png') ;
            min-height: 100vh;
            font-family: sans-serif;
            /*padding-top: 70px;*/
        }

        .booking-form {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 40px;
        }

        .form-section {
            max-width: 1000px;
            margin: 100px auto 30px;

        }


        .title {
            color: white;
            text-shadow: 1px 1px 2px black;
        }

        footer {
            background: white;
            /*padding: 20px;*/
            text-align: center;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
    <div class="container-fluid px-5 ">
        <a class="navbar-brand" href="#">TrainTicket</a>
        <div class="navbar-nav">
            <a class="nav-link text-white" th:href="@{/user/home}"
               th:classappend="${menu == 'userHome'} ? 'active' ">Home</a>
            <a class="nav-link text-white" th:href="@{/user/trip/list}"
               th:classappend="${menu == 'trip'} ? 'active'">Trip</a>
            <a class="nav-link text-white" href="#">Train Seat</a>
            <a class="nav-link text-white" th:href="@{/user/support}"
               th:classappend="${menu == 'support'} ? 'active'">Support</a>
            <a class="nav-link text-white" href="#">Q&A</a>
        </div>

        <div class="d-flex text-white ms-auto">
            <!--            <button class="btn btn-light" type="button">-->
            <a th:href="@{/user/order/view}" class="nav-link text-white">
                <i class="bi bi-cart "> Đơn hàng</i>
            </a>
            <div class="dropdown">
                <!-- Nút icon tài khoản -->
                <button class="btn btn-light" type="button" id="accountDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-person"></i>
                    <span th:if="${currentUser != null}"
                          th:text="${currentUser.fullname}"></span>
                    <span th:if="${currentUser == null}">Tài khoản</span>
                </button>

                <!-- Danh sách tùy chọn -->
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="accountDropdown">
                    <!-- Nếu đã đăng nhập -->
                    <li th:if="${currentUser != null}">
                        <a class="dropdown-item text-primary" th:each="role : ${currentUser.role}"
                           th:if="${role == 'ADMIN'}"
                           th:href="@{/admin/home}">ADMIN</a>
                        <hr class="" >
                    </li>
                    <li th:if="${currentUser != null}">
                        <a class="dropdown-item" th:href="@{/cart/checkout}">Checkout</a>
                    </li>
                    <li th:if="${currentUser != null}">
                        <a class="dropdown-item" th:href="@{/cart/checkout-vnpay}">VNPAY</a>
                    </li>
                    <li th:if="${currentUser != null}">
                        <a class="dropdown-item" th:href="@{/orders}">Đơn hàng</a>
                    </li>
                    <li th:if="${currentUser != null}">
                        <a class="dropdown-item" th:href="@{/wishlist}">Yêu thích</a>
                    </li>
                    <li th:if="${currentUser != null}">
                        <a class="dropdown-item" th:href="@{/logout}">Đăng xuất</a>
                    </li>

                    <!-- Nếu chưa đăng nhập -->
                    <li th:if="${currentUser == null}">
                        <a class="dropdown-item" th:href="@{/login}">Đăng nhập</a>
                    </li>
                    <li th:if="${currentUser == null}">
                        <a class="dropdown-item" th:href="@{/register}">Tạo tài khoản</a>
                    </li>

                </ul>
            </div>


        </div>
    </div>
</nav>

<div class="ticket-summary">
    <h2>Thanh toán vé tàu</h2>

    <!-- Thông tin tuyến -->
    <h4>
        <span th:text="${order.tickets[0].departureStation} + ' → ' + ${order.tickets[0].arrivalStation}">
            Tuyến: Hà Nội → Sài Gòn
        </span>
        <span style="float:right;" th:text="${order.tickets[0].trainName}">Mã tàu</span>
    </h4>

    <!-- Thời gian -->
    <p style="margin-bottom: 25px;"
       th:text="${#temporals.format(order.tickets[0].departureAt, 'HH:mm dd/MM/yyyy')} + ' → ' + ${#temporals.format(order.tickets[0].arrivalAt, 'HH:mm dd/MM/yyyy')}">
        09:00 23/07/2025 → 14:00 24/07/2025
    </p>

    <!-- Danh sách vé -->
    <div th:each="ticket, iterStat : ${order.tickets}">
        <div class="form-group">
            <label th:text="'Vé ' + ${iterStat.index + 1} + ':'">Vé 1:</label>
            <div style="background: #f1f1f1; padding: 10px; border-radius: 4px;">
                Toa <span th:text="${ticket.coachCode}">A1</span> – Ghế <span th:text="${ticket.seatCode}">01</span> –
                Loại vé:
                <span th:text="${ticket.ticketType == 0 ? 'Người lớn' : (ticket.ticketType == 1 ? 'Trẻ em' : (ticket.ticketType == 2 ? 'Học sinh' : (ticket.ticketType == 3 ? 'Người cao tuổi' : 'Khác')))}">
                    Người lớn
                </span> —
<!--                ${#numbers.formatDecimal(ticket.price, 0, 'COMMA', 3, 'POINT')}-->
                <strong th:text="${#numbers.formatDecimal(ticket.price,  0, 'COMMA', 0, 'POINT')} + ' đ'">500,000 đ</strong>
<!--                <span th:text="${ticket.price}"></span>-->

            </div>
        </div>
    </div>

    <!-- Tổng tiền -->
    <div class="price-detail ">
        <span>Tổng tiền vé</span>
        <span th:text="${#numbers.formatDecimal(order.totalAmount,  0, 'COMMA', 0, 'POINT')} + ' đ'">1,000,000 đ</span>
<!--        <span th:text="${order.totalAmount}"></span>-->

    </div>

<!--    &lt;!&ndash; Phương thức thanh toán &ndash;&gt;-->
<!--    <div class="payment-methods">-->
<!--        <label>Phương thức thanh toán: </label>-->
<!--        <select class="form-control" name="paymentMethod">-->
<!--            <option value="vnpay">VNPay</option>-->
<!--            <option value="momo">Momo</option>-->
<!--&lt;!&ndash;            <option value="cod">Thanh toán khi nhận vé</option>&ndash;&gt;-->
<!--        </select>-->
<!--    </div>-->

    <!-- Nút thanh toán -->
    <form th:action="@{/user/payment}" method="post">
        <input type="hidden" name="orderId" th:value="${order.orderId}" />
        <button type="submit" class="btn-pay">Thanh toán ngay</button>
    </form>


<!--    &lt;!&ndash; Nút hiển thị modal &ndash;&gt;-->
<!--    <input type="hidden" id="qrOrderId" th:value="${order.orderId}" />-->
<!--    <button class="btn-pay" onclick="showQRModal()">Thanh toán bằng QR</button>-->

    <!-- Modal QR -->
    <div id="qr-modal" style="display:none; position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #ccc; z-index: 999;">
        <div id="qrcode"></div>
        <button onclick="closeQRModal()">Đóng</button>
    </div>

</div>


<!-- Thêm thư viện tạo QR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script th:inline="javascript">
    function showQRModal() {
        // const orderId = [[${order.orderId}]];  // Nhúng Thymeleaf đúng cách
        const orderId = document.getElementById("qrOrderId").value;

        fetch(`/trainticket/user/qr-payment/generate?orderId=${orderId}`)
            .then(response => response.json())
            .then(data => {
                if (data.paymentUrl) {
                    document.getElementById("qr-modal").style.display = "block";
                    document.getElementById("qrcode").innerHTML = "";
                    new QRCode(document.getElementById("qrcode"), {
                        text: data.paymentUrl,
                        width: 256,
                        height: 256,
                        colorDark: "#000000",
                        colorLight: "#ffffff"
                    });
                } else {
                    alert("Không tạo được mã QR");
                }
            });
    }
    function closeQRModal() {
        document.getElementById("qr-modal").style.display = "none";
    }
</script>


</body>
</html>
